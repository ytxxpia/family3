<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>家庭空间 · 汇总</title>
    <style>
        /* 基础风格：极小圆角（6px），无毛玻璃无阴影 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #0079FF 0%, #ffffff 100%);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px; /* 基准1rem=16px */
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        /* 标题：字号略减 */
        h1 {
            font-size: 1.8rem;       /* 28.8px */
            font-weight: 400;
            margin: 1rem 0 1.2rem 0;
            letter-spacing: 1px;
            color: #0a1a2f;
        }
        /* 两列布局 */
        .row {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        /* 天气块：直角 → 6px圆角 */
        .weather-block {
            flex: 1 1 280px;
            background: rgba(255, 255, 255, 0.3);
            padding: 1.2rem 1rem;
            cursor: pointer;
            border: none;
            border-radius: 6px;
        }
        /* 过期警告背景 */
        .weather-block.expired-bg {
            background-color: #ffe5e5;
        }
        .weather-display {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .weather-icon {
            font-size: 2.2rem;       /* 35.2px */
            width: 1.5em;
            text-align: center;
            color: #1e3a6b;
        }
        .weather-info {
            font-size: 1.3rem;       /* 20.8px */
            font-weight: 350;
            line-height: 1.3;
        }
        .expired-warning {
            margin-top: 0.5rem;
            font-size: 0.8rem;       /* 12.8px */
            color: #b91c1c;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        /* 每日一图容器：强制16:9，6px圆角 */
        .daily-image-link {
            flex: 2 1 400px;          /* 保持弹性，基础宽度400px */
            aspect-ratio: 16 / 9;      /* 关键：强制16:9比例 */
            display: block;
            text-decoration: none;
            color: inherit;
            background: transparent;
            border-radius: 6px;
            overflow: hidden;         /* 确保 iframe 也显示圆角 */
            cursor: pointer;
        }
        .daily-image-link iframe {
            width: 100%;
            height: 100%;              /* 填充父容器，保持比例 */
            border: none;
            display: block;
            background: rgba(255,255,255,0.2);
            pointer-events: none;      /* 使点击由父链接处理 */
        }
        /* 文章列表区域：6px圆角 */
        .article-section {
            background: rgba(255, 255, 255, 0.3);
            padding: 1.2rem 1.2rem;
            border-radius: 6px;
        }
        .article-section h2 {
            font-weight: 350;
            font-size: 1.5rem;        /* 24px */
            margin-bottom: 0.5rem;
        }
        .article-list {
            list-style: none;
            margin-top: 0.5rem;
        }
        .article-list li {
            margin-bottom: 0.8rem;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            padding-bottom: 0.5rem;
        }
        .article-list a {
            text-decoration: none;
            color: #003c8b;
            font-size: 1rem;          /* 16px */
            display: inline-block;
            transition: opacity 0.1s;
            cursor: pointer;
            line-height: 1.4;
        }
        .article-list a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            width: 95%;
            max-width: 500px;
            height: 450px;
            padding: 0;
            border-radius: 6px;       /* 小圆角 */
            position: relative;
            border: none;
            overflow: hidden;         /* 裁剪 iframe 为圆角 */
        }
        .modal-close {
            position: absolute;
            top: 8px; right: 12px;
            font-size: 2.2rem;
            color: #333;
            cursor: pointer;
            background: transparent;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border: none;
            font-weight: 300;
        }
        .modal iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;         /* 无圆角，但父容器 overflow:hidden 会裁剪 */
        }
        /* 图标字体 */
        @font-face {
            font-family: 'Font Awesome 6 Free';
            font-style: normal;
            font-weight: 900;
            src: url('../FontAwesome/fa-solid-900.woff2') format('woff2');
            font-display: block;
        }
        .fas, .fa-solid {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            line-height: 1;
        }
    </style>
    <!-- FontAwesome CDN 备用 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="container">
    <h1><i class="fas fa-home"></i> 家庭空间</h1>

    <div class="row">
        <!-- 天气模块 -->
        <div class="weather-block" id="weatherModule">
            <div class="weather-display" id="weatherDisplay">
                <span class="weather-icon" id="weatherIcon"><i class="fas fa-sun"></i></span>
                <span class="weather-info" id="weatherText">--℃/-</span>
            </div>
            <div id="expiryWarning" class="expired-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle" style="color:#b91c1c;"></i>
                <span>数据已超过8小时，点击更新</span>
            </div>
        </div>

        <!-- 每日一图区域：强制16:9 -->
        <a href="api/bing.html" target="_blank" rel="noopener" class="daily-image-link">
            <iframe src="api/index-see/index-bing.html" title="每日一图" loading="lazy"></iframe>
        </a>
    </div>

    <!-- 文章列表区域 -->
    <div class="article-section">
        <h2><i class="fas fa-file-alt"></i> 文章</h2>
        <ul class="article-list" id="articleList">
            <li>加载中…</li>
        </ul>
    </div>
</div>

<!-- 天气模态框 -->
<div class="modal" id="weatherModal">
    <div class="modal-content">
        <span class="modal-close" id="closeModalBtn">&times;</span>
        <iframe src="api/weather.html" id="weatherIframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"></iframe>
    </div>
</div>

<script>
    (function() {
        const STORAGE_KEY = 'weather_cache';
        const EXPIRY_MS = 8 * 60 * 60 * 1000;

        const iconMap = [
            { keywords: ['晴', 'clear', 'sunny'], icon: 'sun' },
            { keywords: ['多云', 'cloudy', 'partly'], icon: 'cloud' },
            { keywords: ['阴', 'overcast'], icon: 'cloud' },
            { keywords: ['雨', 'rain', 'shower'], icon: 'cloud-rain' },
            { keywords: ['雪', 'snow', 'blizzard'], icon: 'snowflake' },
            { keywords: ['雾', 'fog', 'mist'], icon: 'smog' },
            { keywords: ['雷', 'thunder', 'storm'], icon: 'cloud-bolt' },
            { keywords: ['风', 'wind'], icon: 'wind' }
        ];
        const DEFAULT_ICON = 'sun';

        const weatherModule = document.getElementById('weatherModule');
        const weatherIconSpan = document.getElementById('weatherIcon');
        const weatherTextSpan = document.getElementById('weatherText');
        const expiryWarningDiv = document.getElementById('expiryWarning');
        const modal = document.getElementById('weatherModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const weatherIframe = document.getElementById('weatherIframe');

        function getIconClass(weatherDesc) {
            if (!weatherDesc) return DEFAULT_ICON;
            const lower = weatherDesc.toLowerCase();
            for (let group of iconMap) {
                if (group.keywords.some(kw => lower.includes(kw))) {
                    return group.icon;
                }
            }
            return DEFAULT_ICON;
        }

        function updateWeatherUI(weatherStr, iconName) {
            let displayText = weatherStr || '--℃/-';
            let finalIcon = iconName || DEFAULT_ICON;
            weatherIconSpan.innerHTML = `<i class="fas fa-${finalIcon}"></i>`;
            weatherTextSpan.innerText = displayText;
        }

        function loadCachedWeather() {
            try {
                const cached = localStorage.getItem(STORAGE_KEY);
                if (!cached) {
                    updateWeatherUI('--℃/-', DEFAULT_ICON);
                    weatherModule.classList.remove('expired-bg');
                    expiryWarningDiv.style.display = 'none';
                    return;
                }
                const data = JSON.parse(cached);
                const now = Date.now();
                const age = now - data.timestamp;
                const expired = age > EXPIRY_MS;

                updateWeatherUI(data.value, data.icon || DEFAULT_ICON);

                if (expired) {
                    weatherModule.classList.add('expired-bg');
                    expiryWarningDiv.style.display = 'flex';
                } else {
                    weatherModule.classList.remove('expired-bg');
                    expiryWarningDiv.style.display = 'none';
                }
            } catch (e) {
                updateWeatherUI('--℃/-', DEFAULT_ICON);
                weatherModule.classList.remove('expired-bg');
                expiryWarningDiv.style.display = 'none';
            }
        }

        function saveWeather(weatherStr) {
            if (!weatherStr || !weatherStr.includes('/')) return;

            const parts = weatherStr.split('/');
            const temperature = parts[0];
            const weatherDesc = parts[1] || '';
            const iconClass = getIconClass(weatherDesc);

            const cacheData = {
                value: weatherStr,
                icon: iconClass,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cacheData));

            updateWeatherUI(weatherStr, iconClass);
            weatherModule.classList.remove('expired-bg');
            expiryWarningDiv.style.display = 'none';

            // 不关闭模态框
        }

        weatherModule.addEventListener('click', () => {
            modal.classList.add('active');
            weatherIframe.src = 'api/weather.html';
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        window.addEventListener('message', (event) => {
            if (event.source !== weatherIframe.contentWindow) return;
            const weatherData = event.data;
            if (typeof weatherData === 'string' && weatherData.includes('/')) {
                saveWeather(weatherData);
            } else {
                console.warn('未知的天气消息格式', weatherData);
            }
        });

        loadCachedWeather();

        // 文章列表
        const articleListEl = document.getElementById('articleList');

        async function loadArticles() {
            try {
                const response = await fetch('blog/list.json');
                if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                const articles = await response.json();
                if (!Array.isArray(articles)) throw new Error('列表格式错误');

                if (articles.length === 0) {
                    articleListEl.innerHTML = '<li>暂无文章</li>';
                    return;
                }

                articleListEl.innerHTML = articles.map(item => {
                    const title = item.title || '无标题';
                    const file = item.file || '';
                    return `<li><a href="#" data-file="${file}">${title}</a></li>`;
                }).join('');

                document.querySelectorAll('.article-list a').forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const file = link.dataset.file;
                        if (!file) return;

                        try {
                            const mdResp = await fetch(`blog/${file}`);
                            if (!mdResp.ok) throw new Error('获取文章失败');
                            const markdown = await mdResp.text();

                            const readWin = window.open('read/read.html', '_blank');
                            if (!readWin) {
                                alert('无法打开阅读窗口，请允许弹出窗口后重试。');
                                return;
                            }

                            setTimeout(() => {
                                readWin.postMessage(markdown, window.location.origin);
                            }, 1000);
                        } catch (err) {
                            alert('加载文章出错: ' + err.message);
                        }
                    });
                });
            } catch (err) {
                articleListEl.innerHTML = `<li style="color:#a00;"><i class="fas fa-exclamation-circle"></i> 文章列表加载失败: ${err.message}</li>`;
                console.error(err);
            }
        }

        loadArticles();
    })();
</script>
</body>
</html>
