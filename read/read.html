<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简阅读器 · 经典超链接（原始点击区域）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #1e2b3c;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .reader {
            max-width: 820px;
            width: 100%;
        }
        #markdown-container {
            width: 100%;
            word-wrap: break-word;
        }
        /* 最老式超链接：蓝色+下划线，无内边距，点击区域仅限文本 */
        #share-link {
            display: inline;               /* 确保是行内元素，宽度由文本决定 */
            color: #0066cc;                 /* 经典蓝色 */
            text-decoration: underline;     /* 下划线 */
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
            background: none;
            border: none;
            outline: none;
            /* 无 padding，无 margin 改动，保持原始点击区域 */
            user-select: none;               /* 防止选中（可选，不影响点击区域） */
            -webkit-touch-callout: none;     /* 禁用长按菜单，保证长按事件正常工作 */
        }
        #share-link:hover {
            color: #0052a3;                  /* 悬停加深一点 */
        }
    </style>
</head>
<body>
    <div class="reader">
        <div id="markdown-container"></div>
        <a href="#" id="share-link">分享</a>
    </div>

    <!-- 同级目录 marked.js (如果加载失败，降级处理) -->
    <script src="./marked.js"></script>
    <script>
        (function() {
            const container = document.getElementById('markdown-container');
            const shareLink = document.getElementById('share-link');

            let lastSource = '';
            let longPressTimer = null;
            let longPressTriggered = false;
            const LONG_PRESS_DELAY = 500;

            // ---------- 辅助函数 ----------
            function clearContainer() { container.innerHTML = ''; }

            function escapeHtml(unsafe) {
                return unsafe.replace(/[&<>"]/g, m => {
                    if(m === '&') return '&amp;';
                    if(m === '<') return '&lt;';
                    if(m === '>') return '&gt;';
                    if(m === '"') return '&quot;';
                    return m;
                });
            }

            function renderMarkdown(markdownText) {
                console.log('收到消息:', markdownText);
                let source = '';
                try {
                    if (typeof markdownText !== 'string') {
                        if (markdownText === null || markdownText === undefined) source = '';
                        else if (typeof markdownText === 'object') {
                            try { source = JSON.stringify(markdownText, null, 2); }
                            catch (e) { source = String(markdownText); }
                        } else source = String(markdownText);
                    } else source = markdownText;

                    lastSource = source;

                    if (source.trim() === '') {
                        clearContainer();
                        return;
                    }

                    let html = '';
                    if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
                        html = marked.parse(source);
                    } else if (typeof marked !== 'undefined' && typeof marked === 'function') {
                        html = marked(source);
                    } else {
                        console.warn('marked 不可用，以纯文本显示源码');
                        html = `<pre style="white-space: pre-wrap;">${escapeHtml(source)}</pre>`;
                    }

                    container.innerHTML = html;
                } catch (err) {
                    console.error('渲染失败，降级为纯文本:', err);
                    container.innerHTML = `<pre style="white-space: pre-wrap;">${escapeHtml(source)}</pre>`;
                }
            }

            function performShare() {
                console.log('执行分享：打开 share.html');
                const newWin = window.open('share.html');
                if (!newWin) {
                    console.warn('无法打开 share.html，请检查弹窗拦截');
                    return;
                }
                newWin.addEventListener('load', function() {
                    newWin.postMessage(lastSource, window.location.origin);
                }, { once: true });
            }

            // ---------- 长按事件处理 ----------
            function startLongPress(e) {
                e.preventDefault();   // 阻止默认（拖拽、选中、弹出菜单）
                if (longPressTimer) clearTimeout(longPressTimer);
                longPressTriggered = false;

                longPressTimer = setTimeout(() => {
                    console.log('长按触发，发送消息给自身');
                    window.postMessage('**hallo would!**', '*');
                    longPressTriggered = true;
                    longPressTimer = null;
                }, LONG_PRESS_DELAY);
            }

            function cancelLongPress(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }

            // ---------- 事件绑定 ----------
            shareLink.addEventListener('mousedown', startLongPress);
            shareLink.addEventListener('mouseup', cancelLongPress);
            shareLink.addEventListener('mouseleave', cancelLongPress);
            shareLink.addEventListener('touchstart', startLongPress, { passive: false });
            shareLink.addEventListener('touchend', cancelLongPress);
            shareLink.addEventListener('touchcancel', cancelLongPress);

            shareLink.addEventListener('click', function(e) {
                e.preventDefault();   // 阻止 # 跳转
                if (longPressTriggered) {
                    longPressTriggered = false;
                    return;
                }
                performShare();
            });

            window.addEventListener('message', event => renderMarkdown(event.data));

            clearContainer();
            console.log('经典超链接（原始点击区域）已就绪');
        })();
    </script>
</body>
</html>
